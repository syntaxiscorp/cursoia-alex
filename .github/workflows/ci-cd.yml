name: CI Pipeline - DevSecOpsDemo

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'
  SOLUTION_PATH: './DevSecOpsDemo.sln'
  BUILD_CONFIGURATION: 'Release'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: ğŸ—ï¸ Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“‹ Display .NET Info
      run: dotnet --info
    
    - name: ğŸ”§ Cache NuGet packages
      uses: actions/cache@v3
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
    
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: ğŸ—ï¸ Build Solution (Release)
      run: dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-restore
    
    - name: ğŸ§ª Run Unit Tests
      run: dotnet test ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --verbosity normal --logger "trx;LogFileName=test-results.trx" --collect:"XPlat Code Coverage"
    
    - name: ğŸ“Š Publish Test Results
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: ğŸ§ª Test Results
        path: '**/test-results.trx'
        reporter: dotnet-trx
    
    - name: ğŸ“¦ Create Release Build
      run: dotnet publish src/DevSecOpsDemo.Api/DevSecOpsDemo.Api.csproj --configuration ${{ env.BUILD_CONFIGURATION }} --no-build --output ./build/api --self-contained false
    
    - name: ğŸ“„ Generate Build Info
      run: |
        echo "# DevSecOpsDemo Build Information" > ./build/BUILD_INFO.md
        echo "" >> ./build/BUILD_INFO.md
        echo "**Build Date:** $(date -u)" >> ./build/BUILD_INFO.md
        echo "**Commit SHA:** ${{ github.sha }}" >> ./build/BUILD_INFO.md
        echo "**Branch:** ${{ github.ref_name }}" >> ./build/BUILD_INFO.md
        echo "**Configuration:** ${{ env.BUILD_CONFIGURATION }}" >> ./build/BUILD_INFO.md
        echo "**Triggered by:** ${{ github.event_name }}" >> ./build/BUILD_INFO.md
        echo "" >> ./build/BUILD_INFO.md
        echo "## How to run:" >> ./build/BUILD_INFO.md
        echo "\`\`\`bash" >> ./build/BUILD_INFO.md
        echo "dotnet DevSecOpsDemo.Api.dll" >> ./build/BUILD_INFO.md
        echo "\`\`\`" >> ./build/BUILD_INFO.md
    
    - name: â¬†ï¸ Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: devsecopsdemo-build-${{ github.sha }}
        path: ./build/
        retention-days: 30
        if-no-files-found: error

  # Job 2: Code Quality Analysis  
  code-quality:
    name: ğŸ” Code Quality
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: ğŸ” Run Code Analysis
      run: |
        echo "ğŸ” Running static code analysis..."
        dotnet build ${{ env.SOLUTION_PATH }} --configuration ${{ env.BUILD_CONFIGURATION }} --verbosity normal
    
    - name: ğŸ›¡ï¸ Initialize CodeQL
      if: github.event_name == 'push' || github.event_name == 'pull_request'
      uses: github/codeql-action/init@v3
      with:
        languages: csharp
    
    - name: ğŸ›¡ï¸ Perform CodeQL Analysis  
      if: github.event_name == 'push' || github.event_name == 'pull_request'
      uses: github/codeql-action/analyze@v3

  # Job 3: Security Scan
  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: âš™ï¸ Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_PATH }}
    
    - name: ğŸ”’ Security Vulnerability Scan
      run: |
        echo "ğŸ”’ Running security vulnerability scan..."
        dotnet list package --vulnerable --include-transitive || true
        echo "âœ… Security scan completed"
    
    - name: ğŸ” Dependency Check
      run: |
        echo "ğŸ” Checking for outdated packages..."
        dotnet list package --outdated || true